<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUDANG NASHIR DEPOK</title>
    
    <!-- PWA Manifest & Theme -->
    <meta name="theme-color" content="#0284c7"/>
    <link rel="apple-touch-icon" href="https://i.imgur.com/Xhhb4ks.jpeg">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiR1VEQU5HIE5BU0hJUiBERVBLSyIsInNob3J0X25hbWUiOiJHdWRhbmcgRFBLIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiMwMjg0YzciLCJkZXNjcmlwdGlvbiI6IkFwbGlrYXNpIE1hbmFqZW1lbiBJbnZlbnRhcmlzIEd1ZGFuZy4iLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLmltZ3VyLmNvbS9YaGhiNGtzLmpwZWciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvanBlZyJ9LHsic3JjIjoiaHR0cHM6Ly9pLmltZ3VyLmNvbS9YaGhiNGtzLmpwZWciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvanBlZyJ9XX0=">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- JsBarcode for barcode generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- html5-qrcode for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- SweetAlert2 for modern alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .swal2-popup {
            border-radius: 1rem;
        }
        .swal2-title {
            font-size: 1.5rem;
        }
        .swal2-html-container {
             font-size: 1rem;
        }
        #reader {
            width: 100%;
            max-width: 500px;
            margin: auto;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .btn-primary {
            @apply bg-sky-600 text-white hover:bg-sky-700 focus:ring-4 focus:ring-sky-300;
        }
        .btn-secondary {
            @apply bg-slate-500 text-white hover:bg-slate-600 focus:ring-4 focus:ring-slate-300;
        }
        .btn-success {
            @apply bg-teal-600 text-white hover:bg-teal-700 focus:ring-4 focus:ring-teal-300;
        }
        .btn-danger {
            @apply bg-rose-600 text-white hover:bg-rose-700 focus:ring-4 focus:ring-rose-300;
        }
        .card {
            @apply bg-white rounded-xl shadow-md p-6;
        }
       
        /* --- PERUBAHAN TAMPILAN TABEL HP --- */
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1.5rem;
                /* border: 1px solid #bae6fd; */ /* Garis pemisah baris dihilangkan */
                border-radius: 0.75rem;
                background-color: #f0f9ff; /* Warna latar belakang tetap untuk keterbacaan */
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
                overflow-x: auto; 
                white-space: nowrap; 
                padding: 0.5rem;
            }
            .responsive-table td {
                display: inline-block;
                vertical-align: top;
                padding: 0.75rem 1rem; /* Padding disesuaikan untuk memberi ruang */
                text-align: center;
                /* border-right: 1px solid #e0f2fe; */ /* Garis pemisah antar kolom dihilangkan */
                min-width: 140px; 
                white-space: normal;
            }
            .responsive-table td:last-child {
                /* border-right: none; */ /* Tidak lagi diperlukan */
            }
            .responsive-table td::before {
                content: attr(data-label);
                display: block;
                font-weight: 600;
                color: #0c4a6e;
                margin-bottom: 0.5rem;
                font-size: 0.75rem;
                text-transform: uppercase;
            }

            .responsive-table td[data-label="Aksi"] .flex,
            .responsive-table td[data-label="Detail"] .flex {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <!-- Loading Overlay -->
        <div v-if="isLoading && !isLoggedIn" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-sky-600"></i>
                <p class="mt-4 text-lg font-semibold text-gray-700">Menghubungkan ke database...</p>
            </div>
        </div>

        <!-- Login Page -->
        <div v-if="!isLoggedIn" class="flex items-center justify-center min-h-screen bg-slate-100">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg m-4">
                <div class="flex flex-col items-center">
                    <img src="https://i.imgur.com/Xhhb4ks.jpeg" alt="Logo" class="w-20 h-20 rounded-full object-cover mb-4">
                    <h2 class="text-2xl font-bold text-center text-gray-800">Login Gudang</h2>
                    <p class="text-sm text-gray-500">Silakan masuk untuk melanjutkan</p>
                </div>
                <form @submit.prevent="handleLogin" class="space-y-6">
                    <div>
                        <label for="username" class="text-sm font-medium text-gray-700">Username</label>
                        <input v-model="username" id="username" type="text" required class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition-colors">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                        <input v-model="password" id="password" type="password" required class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition-colors">
                    </div>
                    <div>
                        <button type="submit" class="w-full py-3 px-4 font-semibold text-white bg-sky-600 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-transform transform hover:scale-105">
                            Login
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div v-else class="relative min-h-screen md:flex">
            <!-- Mobile overlay -->
            <div v-if="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-black opacity-50 z-20 md:hidden"></div>

            <!-- Sidebar -->
            <aside class="bg-white text-gray-800 p-4 shadow-lg fixed inset-y-0 left-0 transform md:relative md:translate-x-0 transition-all duration-300 ease-in-out z-30 flex flex-col"
                   :class="{'w-64': !isSidebarMinimized, 'w-20': isSidebarMinimized, 'translate-x-0': isMenuOpen, '-translate-x-full': !isMenuOpen}">
                <!-- Sidebar Header -->
                <div class="flex items-center space-x-3 p-2 mb-8 h-12" :class="{'justify-center': isSidebarMinimized, 'space-x-0': isSidebarMinimized}">
                     <img src="https://i.imgur.com/Xhhb4ks.jpeg" alt="Logo" class="h-10 w-10 rounded-md object-cover">
                     <h1 v-show="!isSidebarMinimized" class="text-xl font-bold text-gray-800">WAREHOUSE</h1>
                </div>

                <!-- Nav Links -->
                <nav class="flex-grow flex flex-col space-y-2">
                    <a @click.prevent="changeView('dashboard'); isMenuOpen = false" href="#" class="flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'dashboard', 'justify-center': isSidebarMinimized}">
                        <i class="fas fa-tachometer-alt fa-fw w-6" :class="isSidebarMinimized ? 'mr-0' : 'mr-2'"></i> 
                        <span v-show="!isSidebarMinimized">Dashboard</span>
                    </a>

                    <!-- Gudang Collapsible Menu -->
                    <div>
                        <button @click="isGudangMenuOpen = !isGudangMenuOpen" class="flex items-center justify-between w-full py-2.5 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'justify-center': isSidebarMinimized}">
                            <div class="flex items-center">
                                <i class="fas fa-warehouse fa-fw w-6" :class="isSidebarMinimized ? 'mr-0' : 'mr-2'"></i> 
                                <span v-show="!isSidebarMinimized">Gudang</span>
                            </div>
                            <i v-show="!isSidebarMinimized" class="fas fa-chevron-down text-xs transition-transform" :class="{'rotate-180': isGudangMenuOpen}"></i>
                        </button>
                        <div v-show="isGudangMenuOpen && !isSidebarMinimized" class="pl-8 pt-2 space-y-2">
                            <a @click.prevent="changeView('gudangManagement'); isMenuOpen = false" href="#" class="flex items-center text-sm py-2 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'gudangManagement'}">Kelola Gudang</a>
                            <a @click.prevent="changeView('packing'); isMenuOpen = false" href="#" class="flex items-center text-sm py-2 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'packing'}">Packingan</a>
                            <a @click.prevent="changeView('products'); isMenuOpen = false" href="#" class="flex items-center text-sm py-2 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'products'}">Daftar Produk</a>
                            <a @click.prevent="changeView('stockIn'); isMenuOpen = false" href="#" class="flex items-center text-sm py-2 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'stockIn'}">Barang Masuk</a>
                            <a @click.prevent="changeView('stockOut'); isMenuOpen = false" href="#" class="flex items-center text-sm py-2 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'stockOut'}">Barang Keluar</a>
                        </div>
                    </div>
                    
                    <a @click.prevent="changeView('history'); isMenuOpen = false" href="#" class="flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'history', 'justify-center': isSidebarMinimized}">
                        <i class="fas fa-history fa-fw w-6" :class="isSidebarMinimized ? 'mr-0' : 'mr-2'"></i>
                        <span v-show="!isSidebarMinimized">Kartu Product</span>
                    </a>
                    <a @click.prevent="changeView('reports'); isMenuOpen = false" href="#" class="flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-sky-50 hover:text-sky-700" :class="{'bg-sky-100 text-sky-700 font-semibold': currentView === 'reports', 'justify-center': isSidebarMinimized}">
                        <i class="fas fa-file-alt fa-fw w-6" :class="isSidebarMinimized ? 'mr-0' : 'mr-2'"></i>
                        <span v-show="!isSidebarMinimized">Laporan</span>
                    </a>
                </nav>

                <!-- Sidebar Toggle -->
                <div class="mt-auto hidden md:block">
                    <button @click="toggleSidebar" class="flex items-center w-full py-2.5 px-4 rounded-lg transition duration-200 text-gray-600 hover:bg-gray-200" :class="{'justify-center': isSidebarMinimized}">
                         <i class="fas fa-fw w-6" :class="isSidebarMinimized ? 'fa-angle-double-right' : 'fa-angle-double-left'"></i>
                         <span v-show="!isSidebarMinimized" class="ml-2">Perkecil</span>
                    </button>
                </div>
            </aside>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col">
                <!-- Header -->
                <header class="bg-sky-600 shadow-md p-4 flex items-center justify-center sticky top-0 z-10 relative">
                     <!-- Mobile Menu Button -->
                     <button @click="isMenuOpen = !isMenuOpen" class="md:hidden text-white focus:outline-none absolute left-4 top-1/2 -translate-y-1/2">
                        <i class="fas fa-bars text-2xl"></i>
                     </button>
                     <h1 class="text-xl font-bold text-white">GUDANG NASHIR DEPOK</h1>
                     <!-- Profile Button -->
                     <div class="absolute right-4 top-1/2 -translate-y-1/2">
                         <button @click="openProfileModal" class="text-white text-2xl hover:text-sky-200 transition">
                             <i class="fas fa-user-circle"></i>
                         </button>
                     </div>
                </header>

                <!-- Main Content -->
                <main class="flex-1 p-4 sm:p-6 lg:p-8">
                    <!-- Dashboard View -->
                    <div v-show="currentView === 'dashboard'">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>

                        <!-- Diagram Section -->
                        <div v-show="products.length === 0" class="card text-center py-10 text-gray-500">
                            <i class="fas fa-chart-bar text-3xl mb-2"></i>
                            <p>Data tidak tersedia. Tambahkan produk untuk melihat diagram.</p>
                        </div>
                        <div v-show="products.length > 0" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Pie Chart for Top Products -->
                            <div class="card flex flex-col items-center">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribusi Stok Produk (Top 5)</h3>
                                <div class="relative h-64 w-full">
                                    <canvas id="productPieChart"></canvas>
                                </div>
                            </div>
                    
                            <!-- Bar Chart for Top Products -->
                            <div class="card">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Top 5 Produk Berdasarkan Stok</h3>
                                 <div class="relative h-64">
                                    <canvas id="topProductsBarChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card overflow-x-auto">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ringkasan Transaksi Hari Ini</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full responsive-table">
                                    <thead>
                                        <tr>
                                            <th class="p-3 font-semibold text-left text-gray-600">Nama Produk</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Masuk Hari Ini</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Keluar Hari Ini</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Stok Akhir</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="reportData.length === 0">
                                            <td colspan="4" class="text-center py-10 text-gray-500">
                                                <i class="fas fa-calendar-times text-3xl mb-2"></i>
                                                <p>Belum ada transaksi untuk hari ini.</p>
                                            </td>
                                        </tr>
                                        <tr v-for="item in reportData" :key="item.sku">
                                            <td data-label="Produk" class="p-3 font-medium">{{ item.name }}</td>
                                            <td data-label="Masuk Hari Ini" class="p-3 text-center text-teal-600 font-semibold">+{{ item.jumlahMasuk }}</td>
                                            <td data-label="Keluar Hari Ini" class="p-3 text-center text-rose-600 font-semibold">-{{ item.jumlahKeluar }}</td>
                                            <td data-label="Stok Akhir" class="p-3 text-center font-bold text-sky-600">{{ item.sisaStok }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                    <!-- Gudang Management View -->
                    <div v-if="currentView === 'gudangManagement'">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Kelola Gudang & Produk</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="card">
                                <h3 class="text-lg font-semibold mb-4">Tambah Gudang Baru</h3>
                                <div class="flex gap-2">
                                    <input v-model="newWarehouseName" @keyup.enter="addWarehouse" type="text" placeholder="Nama Gudang" class="flex-grow p-2 border rounded-lg">
                                    <button @click="addWarehouse" class="btn-primary py-2 px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                             <div class="card">
                                <h3 class="text-lg font-semibold mb-4">Tambah Rak Baru</h3>
                                <div class="flex gap-2">
                                    <select v-model="selectedWarehouseForNewRack" class="flex-grow p-2 border rounded-lg bg-white">
                                        <option value="">Pilih Gudang</option>
                                        <option v-for="wh in warehouses" :key="wh.id" :value="wh.id">{{ wh.name }}</option>
                                    </select>
                                    <input v-model="newRackName" @keyup.enter="addRackToWarehouse" type="text" placeholder="Nama Rak" class="flex-grow p-2 border rounded-lg">
                                    <button @click="addRackToWarehouse" class="btn-primary py-2 px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>

                        <div v-if="warehouses.length === 0" class="card text-center py-10 text-gray-500">
                            <i class="fas fa-warehouse text-3xl mb-2"></i>
                            <p>Belum ada gudang yang ditambahkan.</p>
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="warehouse in warehouses" :key="warehouse.id" class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                                <div class="w-full flex justify-between items-center p-4 bg-sky-50">
                                    <button @click="selectWarehouse(warehouse.id)" class="flex-grow flex items-center text-left hover:opacity-80 transition-opacity">
                                        <h3 class="text-xl font-bold text-sky-800 flex items-center">
                                            <i class="fas fa-warehouse mr-3 text-sky-600"></i>
                                            Gudang: {{ warehouse.name }}
                                        </h3>
                                        <i class="fas fa-chevron-down transition-transform ml-4" :class="{'rotate-180': selectedWarehouseId === warehouse.id}"></i>
                                    </button>
                                    <div class="flex items-center">
                                        <button @click="editWarehouse(warehouse)" class="p-2 text-sky-600 hover:text-sky-800 transition-colors" title="Edit Nama Gudang">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button v-if="loggedInUser === 'erdi'" @click="deleteWarehouse(warehouse)" class="p-2 text-rose-600 hover:text-rose-800 transition-colors" title="Hapus Gudang">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div v-if="selectedWarehouseId === warehouse.id" class="p-4 space-y-4">
                                    <div v-if="!warehouse.racks || warehouse.racks.length === 0" class="text-center text-gray-500 italic p-4">
                                        Belum ada rak di gudang ini.
                                    </div>
                                    <div v-else class="space-y-2">
                                        <div v-for="rack in warehouse.racks" :key="rack" class="rounded-lg border">
                                            <div class="w-full flex justify-between items-center p-3" :class="selectedRackName === rack ? 'bg-sky-100' : 'bg-slate-50'">
                                                <button @click="selectRack(rack)" class="flex-grow flex items-center text-left hover:opacity-80 transition-opacity">
                                                    <span class="font-semibold text-gray-700">
                                                        <i class="fas fa-th-large mr-2 text-gray-500"></i>
                                                        Rak: {{ rack }}
                                                    </span>
                                                    <i class="fas fa-chevron-down transition-transform text-sm ml-4" :class="{'rotate-180': selectedRackName === rack}"></i>
                                                </button>
                                                <div class="flex items-center">
                                                    <button @click.stop="editRack(warehouse, rack)" class="p-2 text-sky-600 hover:text-sky-800 transition-colors" title="Edit Nama Rak">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button v-if="loggedInUser === 'erdi'" @click.stop="deleteRack(warehouse, rack)" class="p-2 text-rose-600 hover:text-rose-800 transition-colors" title="Hapus Rak">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div v-if="selectedRackName === rack" class="p-3 border-t">
                                                <div class="overflow-x-auto">
                                                    <table class="w-full text-sm responsive-table">
                                                        <thead>
                                                            <tr class="bg-slate-100">
                                                                <th class="p-2 font-semibold text-left text-gray-600">Produk</th>
                                                                <th class="p-2 font-semibold text-center text-gray-600">Stok di Rak</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-if="productsInSelectedRack.length === 0">
                                                                <td colspan="2" class="p-3 text-center text-gray-500 italic">Tidak ada produk di rak ini.</td>
                                                            </tr>
                                                            <tr v-for="product in productsInSelectedRack" :key="product.id" class="border-b">
                                                                <td data-label="Produk" class="p-2">{{ product.name }} <span class="text-xs text-gray-500">({{ product.sku }})</span></td>
                                                                <td data-label="Stok di Rak" class="p-2 text-center font-bold">{{ product.stockInRack }}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Packing View -->
                    <div v-if="currentView === 'packing'">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Stok Packingan</h2>
                             <button @click="openPackingEditModal" class="mt-4 sm:mt-0 py-2 px-4 rounded-lg bg-gradient-to-r from-rose-500 to-red-600 text-white font-semibold shadow-md hover:shadow-lg hover:from-rose-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-300 ease-in-out transform hover:-translate-y-px">
                                <i class="fas fa-edit mr-2"></i> Edit Stok Packingan
                            </button>
                        </div>
                         <div class="card mb-6">
                            <input type="text" v-model="searchQuery" placeholder="Cari produk berdasarkan nama atau SKU..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                        </div>
                        <div class="card overflow-x-auto">
                            <table class="w-full responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3 font-semibold text-left text-gray-600">Produk</th>
                                        <th class="p-3 font-semibold text-center text-gray-600">Stok Gudang</th>
                                        <th class="p-3 font-semibold text-center text-gray-600">Stok Single</th>
                                        <th class="p-3 font-semibold text-center text-gray-600">Stok Bundling</th>
                                        <th class="p-3 font-semibold text-center text-gray-600">Total Packingan</th>
                                        <th class="p-3 font-semibold text-center text-gray-600">PIC Terakhir</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="filteredProducts.length === 0">
                                        <td colspan="6" class="text-center py-10 text-gray-500">
                                            <p>Produk tidak ditemukan atau belum ditambahkan.</p>
                                        </td>
                                    </tr>
                                    <tr v-for="product in filteredProducts" :key="product.id">
                                        <td data-label="Produk" class="p-3 font-medium text-gray-800">
                                            {{ product.name }}
                                            <span class="block text-xs text-gray-500">{{ product.sku }}</span>
                                        </td>
                                        <td data-label="Stok Gudang" class="p-3 text-center font-semibold">{{ product.gudangStock }}</td>
                                        <td data-label="Stok Single" class="p-3 text-center">{{ product.packingStockSingle }}</td>
                                         <td data-label="Stok Bundling" class="p-3 text-center">{{ product.packingStockBundling }}</td>
                                        <td data-label="Total Packingan" class="p-3 text-center font-bold text-sky-600">{{ product.packingStock }}</td>
                                        <td data-label="PIC Terakhir" class="p-3 text-center text-sm italic">{{ product.packingPIC }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <!-- Product List View -->
                    <div v-if="currentView === 'products'">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Daftar Produk</h2>
                            <button @click="openAddProductModal" class="mt-4 sm:mt-0 w-full sm:w-auto flex items-center justify-center py-2 px-4 rounded-lg btn-primary">
                                <i class="fas fa-plus mr-2"></i> Tambah Produk
                            </button>
                        </div>
                        <div class="card mb-6">
                            <input type="text" v-model="searchQuery" placeholder="Cari produk berdasarkan nama, SKU, gudang, atau rak..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                        </div>
                        <div class="card overflow-x-auto">
                            <table class="w-full responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3 font-semibold text-left text-gray-600">Nama Produk</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">SKU</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">Barcode</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Total Stok</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Detail</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="filteredProducts.length === 0">
                                        <td colspan="6" class="text-center py-10 text-gray-500">
                                            <i class="fas fa-box-open text-3xl mb-2"></i>
                                            <p>Belum ada produk. Silakan tambahkan produk baru.</p>
                                        </td>
                                    </tr>
                                    <tr v-for="product in filteredProducts" :key="product.sku">
                                        <td data-label="Produk" class="p-3 font-medium text-gray-800">{{ product.name }}</td>
                                        <td data-label="SKU" class="p-3 text-gray-600">{{ product.sku }}</td>
                                        <td data-label="Barcode" class="p-3 text-gray-600 font-mono">{{ product.barcode }}</td>
                                        <td data-label="Total Stok" class="p-3 text-center text-gray-800 font-semibold">{{ product.stock }}</td>
                                        <td data-label="Detail" class="p-3 text-center">
                                            <div class="flex justify-center items-center space-x-2">
                                                <button @click="showProductLocations(product)" class="p-2 text-purple-500 hover:text-purple-700 transition-colors" title="Lihat Lokasi Stok">
                                                    <i class="fas fa-map-marked-alt"></i>
                                                </button>
                                                <button @click="viewProductRecap(product)" class="p-2 text-orange-500 hover:text-orange-700 transition-colors" title="Rekap Barang">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td data-label="Aksi" class="p-3 text-center">
                                             <div class="flex justify-center items-center space-x-2">
                                                <button @click="openMoveProductModal(product)" class="p-2 text-indigo-500 hover:text-indigo-700 transition-colors" title="Pindah Barang">
                                                    <i class="fas fa-truck"></i>
                                                </button>
                                                <button @click="viewProductDetail(product)" class="p-2 text-sky-600 hover:text-sky-800 transition-colors" title="Lihat Detail & Barcode">
                                                    <i class="fas fa-barcode"></i>
                                                </button>
                                                <button v-if="loggedInUser === 'erdi'" @click="deleteProduct(product)" class="p-2 text-rose-600 hover:text-rose-800 transition-colors" title="Hapus Produk">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Stock In / Out View -->
                    <div v-if="currentView === 'stockIn' || currentView === 'stockOut'">
                         <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ currentView === 'stockIn' ? 'Barang Masuk' : 'Barang Keluar' }}</h2>
                         
                         <!-- Scan/Input Section -->
                         <div class="card mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Proses Cepat</h3>
                            <div class="flex flex-col sm:flex-row items-start gap-4">
                                <div class="flex-1 w-full">
                                    <label for="manual-scan" class="block text-sm font-medium text-gray-700 mb-1">Masukkan SKU / Barcode</label>
                                    <div class="flex">
                                        <input type="text" id="manual-scan" v-model="manualScanInput" @keyup.enter="processManualScan" placeholder="Ketik kode di sini..." class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-sky-500">
                                        <button @click="processManualScan" class="px-4 py-2 bg-sky-600 text-white rounded-r-lg hover:bg-sky-700">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="w-full sm:w-auto text-center">
                                     <span class="text-sm text-gray-500 my-2 block sm:hidden">atau</span>
                                     <button v-if="!isScannerActive" @click="startScanner" class="w-full py-2 px-4 rounded-lg bg-teal-500 text-white hover:bg-teal-600 focus:ring-4 focus:ring-teal-300 font-semibold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg">
                                        <i class="fas fa-camera mr-2"></i> SCAN
                                    </button>
                                </div>
                            </div>
                            <div v-if="isScannerActive" class="mt-4 text-center">
                                <div id="reader" class="mx-auto"></div>
                                <button @click="stopScanner" class="mt-4 py-2 px-4 rounded-lg btn-danger">
                                    <i class="fas fa-stop-circle mr-2"></i> Hentikan Pemindai
                                </button>
                            </div>
                         </div>
                         
                        <!-- Stock In View: Last 10 Transactions -->
                        <div v-if="currentView === 'stockIn'">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">10 Transaksi Masuk Terakhir</h3>
                            <div class="card overflow-x-auto">
                                <table class="w-full responsive-table">
                                    <thead>
                                        <tr>
                                            <th class="p-3 font-semibold text-left text-gray-600">Tanggal</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">Nama Produk</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">SKU</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Jumlah</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">Lokasi</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">PIC</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="lastTenStockIn.length === 0">
                                            <td colspan="6" class="text-center py-10 text-gray-500"><p>Belum ada riwayat barang masuk.</p></td>
                                        </tr>
                                        <tr v-for="item in lastTenStockIn" :key="item.id">
                                            <td data-label="Tanggal" class="p-3">{{ formatTimestamp(item.timestamp) }}</td>
                                            <td data-label="Produk" class="p-3 font-medium">{{ item.productName }}</td>
                                            <td data-label="SKU" class="p-3">{{ item.sku }}</td>
                                            <td data-label="Jumlah" class="p-3 text-center font-semibold text-teal-600">+{{ item.quantity }}</td>
                                            <td data-label="Lokasi" class="p-3">{{ item.location }}</td>
                                            <td data-label="PIC" class="p-3">{{ item.pic }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Stock Out View: Last 10 Transactions -->
                        <div v-if="currentView === 'stockOut'">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">10 Transaksi Keluar Terakhir</h3>
                            <div class="card overflow-x-auto">
                                <table class="w-full responsive-table">
                                    <thead>
                                        <tr>
                                            <th class="p-3 font-semibold text-left text-gray-600">Tanggal</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">Nama Produk</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">SKU</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Jumlah</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">Lokasi</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">PIC</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="lastTenStockOut.length === 0">
                                            <td colspan="6" class="text-center py-10 text-gray-500"><p>Belum ada riwayat barang keluar.</p></td>
                                        </tr>
                                        <tr v-for="item in lastTenStockOut" :key="item.id">
                                            <td data-label="Tanggal" class="p-3">{{ formatTimestamp(item.timestamp) }}</td>
                                            <td data-label="Produk" class="p-3 font-medium">{{ item.productName }}</td>
                                            <td data-label="SKU" class="p-3">{{ item.sku }}</td>
                                            <td data-label="Jumlah" class="p-3 text-center font-semibold text-rose-600">-{{ item.quantity }}</td>
                                            <td data-label="Lokasi" class="p-3">{{ item.location }}</td>
                                            <td data-label="PIC" class="p-3">{{ item.pic }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History View (Kartu Stok) -->
                    <div v-if="currentView === 'history'">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Kartu Product</h2>
                        
                        <!-- Cari Cepat -->
                        <div class="card mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Cari Cepat Kartu Stok</h3>
                            <div class="flex flex-col sm:flex-row items-start gap-4">
                                <div class="flex-1 w-full">
                                    <label for="history-manual-scan" class="block text-sm font-medium text-gray-700 mb-1">Masukkan SKU / Barcode</label>
                                    <div class="flex">
                                        <input type="text" id="history-manual-scan" v-model="manualScanInput" @keyup.enter="processManualScan" placeholder="Ketik kode untuk filter..." class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-sky-500">
                                        <button @click="processManualScan" class="px-4 py-2 bg-sky-600 text-white rounded-r-lg hover:bg-sky-700">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="w-full sm:w-auto text-center">
                                     <span class="text-sm text-gray-500 my-2 block sm:hidden">atau</span>
                                     <button v-if="!isScannerActive" @click="startScanner" class="w-full py-2 px-4 rounded-lg bg-teal-500 text-white hover:bg-teal-600 focus:ring-4 focus:ring-teal-300 font-semibold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg">
                                        <i class="fas fa-camera mr-2"></i> SCAN
                                    </button>
                                </div>
                            </div>
                            <div v-if="isScannerActive" class="mt-4 text-center">
                                <div id="reader" class="mx-auto"></div>
                                <button @click="stopScanner" class="mt-4 py-2 px-4 rounded-lg btn-danger">
                                    <i class="fas fa-stop-circle mr-2"></i> Hentikan Pemindai
                                </button>
                            </div>
                        </div>

                        <!-- Filter Produk -->
                        <div class="card mb-6">
                            <label for="stock-card-filter" class="block text-sm font-medium text-gray-700 mb-2">Pilih Produk untuk Melihat Riwayat:</label>
                            <select id="stock-card-filter" v-model="selectedStockCardProduct" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                                <option value="">-- Pilih Produk --</option>
                                <option v-for="product in products" :key="product.sku" :value="product.sku">
                                    {{ product.name }} ({{ product.sku }})
                                </option>
                            </select>
                        </div>

                        <!-- New Summary Card -->
                        <div v-if="selectedStockCardProduct" class="card mb-6 bg-sky-50 border border-sky-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-sm font-semibold text-gray-500">Produk</p>
                                    <p class="text-lg font-bold text-gray-800">{{ stockCardData.productName }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-500">Periode</p>
                                    <p class="text-lg font-bold text-gray-800">{{ stockCardData.periode }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-500">Stok Awal Bulan</p>
                                    <p class="text-lg font-bold text-sky-600">{{ stockCardData.stokAwal }} pcs</p>
                                </div>
                            </div>
                        </div>


                        <div class="card overflow-x-auto">
                            <table class="w-full responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3 font-semibold text-left text-gray-600">Tanggal</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">Produk</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Masuk</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Keluar</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">Lokasi</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">Keterangan</th>
                                        <th class="p-3 font-semibold text-gray-600 text-center">Stok Akhir</th>
                                        <th class="p-3 font-semibold text-left text-gray-600">PIC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="!selectedStockCardProduct">
                                        <td colspan="8" class="text-center py-10 text-gray-500">
                                            <i class="fas fa-info-circle text-3xl mb-2"></i>
                                            <p>Silakan pilih produk di atas untuk melihat kartu stoknya.</p>
                                        </td>
                                    </tr>
                                    <tr v-else-if="stockCardData.transactions.length === 0">
                                        <td colspan="8" class="text-center py-10 text-gray-500">
                                            <i class="fas fa-file-alt text-3xl mb-2"></i>
                                            <p>Tidak ada riwayat transaksi untuk produk ini di bulan ini.</p>
                                        </td>
                                    </tr>
                                    <tr v-for="(item, index) in stockCardData.transactions" :key="index">
                                        <td data-label="Tanggal" class="p-3">{{ formatTimestamp(item.timestamp) }}</td>
                                        <td data-label="Produk" class="p-3">{{ item.productName }}</td>
                                        <td data-label="Masuk" class="p-3 text-center font-semibold text-teal-600">{{ item.type === 'in' ? '+' + item.quantity : '' }}</td>
                                        <td data-label="Keluar" class="p-3 text-center font-semibold text-rose-600">{{ item.type === 'out' ? '-' + item.quantity : '' }}</td>
                                        <td data-label="Lokasi" class="p-3">{{ item.location }}</td>
                                        <td data-label="Keterangan" class="p-3">{{ item.keterangan }}</td>
                                        <td data-label="Stok Akhir" class="p-3 text-center font-bold text-sky-600">{{ item.stokAkhir }}</td>
                                        <td data-label="PIC" class="p-3">{{ item.pic || '-' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Reports View -->
                    <div v-if="currentView === 'reports'">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Laporan</h2>

                        <!-- Custom Date Filter Section -->
                        <div class="card mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filter Laporan Kustom</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                                    <input type="date" id="start-date" v-model="reportStartDate" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                                    <input type="date" id="end-date" v-model="reportEndDate" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-transparent mb-1 hidden md:block">&nbsp;</label>
                                     <button @click="clearDateFilter" class="w-full py-2 px-4 rounded-lg bg-amber-500 text-white hover:bg-amber-600 focus:ring-4 focus:ring-amber-300 font-semibold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg">
                                        <i class="fas fa-sync-alt mr-2"></i> Atur Ulang
                                    </button>
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-transparent mb-1 hidden md:block">&nbsp;</label>
                                     <button @click="downloadReportCSV" class="w-full py-2 px-4 rounded-lg bg-lime-500 text-white hover:bg-lime-600 focus:ring-4 focus:ring-lime-300 font-semibold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg">
                                        <i class="fas fa-file-csv mr-2"></i> Unduh CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Report Table -->
                        <div class="card">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">{{ reportTitle }}</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full responsive-table">
                                    <thead>
                                        <tr>
                                            <th class="p-3 font-semibold text-left text-gray-600">Nama Produk</th>
                                            <th class="p-3 font-semibold text-left text-gray-600">SKU</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Stok Awal</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Total Masuk</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Total Keluar</th>
                                            <th class="p-3 font-semibold text-gray-600 text-center">Sisa Stok</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="reportData.length === 0">
                                            <td colspan="6" class="text-center py-10 text-gray-500">
                                                <i class="fas fa-calendar-day text-3xl mb-2"></i>
                                                <p>Belum ada transaksi pada periode ini.</p>
                                            </td>
                                        </tr>
                                        <tr v-for="item in reportData" :key="item.sku">
                                            <td data-label="Produk" class="p-3 font-medium">{{ item.name }}</td>
                                            <td data-label="SKU" class="p-3">{{ item.sku }}</td>
                                            <td data-label="Stok Awal" class="p-3 text-center">{{ item.stokAwal }}</td>
                                            <td data-label="Masuk" class="p-3 text-center">{{ item.jumlahMasuk }}</td>
                                            <td data-label="Keluar" class="p-3 text-center">{{ item.jumlahKeluar }}</td>
                                            <td data-label="Sisa Stok" class="p-3 text-center">{{ item.sisaStok }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.prod.js"></script>
    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, where, getDocs, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue

        createApp({
            setup() {
                // State Management
                const isLoading = ref(false);
                const isLoggedIn = ref(false);
                const username = ref('');
                const password = ref('');
                const loggedInUser = ref('');
                const currentView = ref('dashboard');
                const isMenuOpen = ref(false);
                const isSidebarMinimized = ref(false);
                const isGudangMenuOpen = ref(false);
                const products = ref([]);
                const transactionHistory = ref([]); // FIX: Renamed from 'history' to avoid conflict
                const warehouses = ref([]);
                const newWarehouseName = ref('');
                const newRackName = ref('');
                const selectedWarehouseForNewRack = ref('');
                const searchQuery = ref('');
                const manualScanInput = ref('');
                const isScannerActive = ref(false);
                const selectedStockCardProduct = ref('');
                const reportStartDate = ref('');
                const reportEndDate = ref('');
                let html5QrCode = null;
                const chartInstances = ref({});
                const selectedWarehouseId = ref(null);
                const selectedRackName = ref(null);


                const allowedUsers = ref([
                    { user: 'gudang', pass: '123' },
                    { user: 'erdi', pass: 'gudang01' },
                    { user: 'krismanto', pass: 'gudang02' },
                    { user: 'luluk', pass: 'gudang03' },
                    { user: 'ghani', pass: 'gudang04' },
                    { user: 'revi', pass: 'gudang05' },
                    { user: 'irvan', pass: 'gudang06' },
                    { user: 'moko', pass: 'gudang07' },
                    { user: 'guruh', pass: 'gudang08' },
                    { user: 'taura', pass: 'gudang09' },
                    { user: 'dicky', pass: 'gudang10' }
                ]);

                // Firebase State
                let db = null;
                let productsCollection = null;
                let historyCollection = null;
                let warehousesCollection = null;

                onMounted(() => {
                    // --- START: BACK BUTTON & HISTORY MANAGEMENT ---
                    // This function handles the browser's back button ('popstate' event)
                    window.addEventListener('popstate', (event) => {
                        // If the state exists, it means we are navigating between app views
                        if (event.state && event.state.view) {
                            currentView.value = event.state.view;
                        } 
                        // If state is null, it means we've gone back to the initial page load state
                        else if (isLoggedIn.value) {
                             // If logged in, show a confirmation dialog to prevent accidental logout
                            Swal.fire({
                                title: 'Keluar dari Aplikasi?',
                                text: "Anda yakin ingin keluar dari sesi ini?",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Ya, Keluar!',
                                cancelButtonText: 'Batal'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    handleLogout();
                                } else {
                                    // If canceled, push the dashboard state back into history
                                    // so the user stays in the app
                                    history.pushState({ view: 'dashboard' }, '', '#dashboard');
                                }
                            });
                        }
                    });
                    // --- END: BACK BUTTON & HISTORY MANAGEMENT ---

                    if (sessionStorage.getItem('isLoggedIn') === 'true') {
                        isLoggedIn.value = true;
                        loggedInUser.value = sessionStorage.getItem('loggedInUser') || '';
                        initializeFirebase();
                    } else {
                        isLoading.value = false;
                    }
                });

                const initializeFirebase = async () => {
                    isLoading.value = true;
                    try {
                        const firebaseConfig = {
                            apiKey: "AIzaSyB5PfcojlBqEv5n-R0d42cQrK6JeSap_LE",
                            authDomain: "gudang-nashir-depok.firebaseapp.com",
                            projectId: "gudang-nashir-depok",
                            storageBucket: "gudang-nashir-depok.appspot.com",
                            messagingSenderId: "1017883769715",
                            appId: "1:1017883769715:web:c7f32334275d6124f62306"
                        };
                        const appId = 'gudang-nashir-depok';

                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        const auth = getAuth(app);
                        
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                             if (error.code === 'auth/configuration-not-found') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Aksi Diperlukan di Firebase',
                                    html: `
                                        <div class="text-left">
                                            <p class="mb-2">Gagal terhubung karena metode login "Anonim" belum aktif.</p>
                                            <p class="mb-4">Untuk mengaktifkannya:</p>
                                            <ol class="list-decimal list-inside space-y-2">
                                                <li>Buka proyek Firebase Anda.</li>
                                                <li>Masuk ke menu <strong>Authentication</strong>.</li>
                                                <li>Pilih tab <strong>Sign-in method</strong>.</li>
                                                <li>Klik <strong>"Add new provider"</strong> dan pilih <strong>Anonymous</strong>.</li>
                                                <li>Aktifkan (enable) dan simpan.</li>
                                            </ol>
                                        </div>
                                    `
                                });
                            }
                            throw error;
                        }

                        const basePath = `/artifacts/${appId}/public/data`;
                        productsCollection = collection(db, `${basePath}/products`);
                        historyCollection = collection(db, `${basePath}/history`);
                        warehousesCollection = collection(db, `${basePath}/warehouses`);
                        setupListeners();

                        // Set the initial state in the browser history without creating a new entry
                        history.replaceState({ view: 'dashboard' }, '', '#dashboard');

                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        if (error.code !== 'auth/configuration-not-found') {
                            Swal.fire('Error Koneksi', 'Gagal terhubung ke database. Periksa konsol untuk detailnya.', 'error');
                        }
                        isLoading.value = false;
                    }
                };

                const handleLogin = () => {
                    const foundUser = allowedUsers.value.find(u => u.user === username.value && u.pass === password.value);

                    if (foundUser) {
                        isLoggedIn.value = true;
                        loggedInUser.value = foundUser.user;
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('loggedInUser', foundUser.user);
                        initializeFirebase();
                    } else {
                        Swal.fire('Gagal Login', 'Username atau password salah.', 'error');
                    }
                };

                const handleLogout = () => {
                    isLoggedIn.value = false;
                    loggedInUser.value = '';
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('loggedInUser');
                    username.value = '';
                    password.value = '';
                    // Go back to the root of the history on logout
                    history.go(-(history.length - 1));
                    window.location.hash = ''; // Clear the hash
                };
                
                const openProfileModal = () => {
                    Swal.fire({
                        title: 'Profil Pengguna',
                        html: `
                            <div class="text-left">
                                <p class="mb-4">Username: <strong class="font-mono">${loggedInUser.value}</strong></p>
                                <hr class="my-4">
                                <h3 class="font-semibold text-lg mb-2">Ubah Password</h3>
                                <input id="swal-input-old-pass" type="password" class="swal2-input" placeholder="Password Lama">
                                <input id="swal-input-new-pass" type="password" class="swal2-input" placeholder="Password Baru">
                                <input id="swal-input-confirm-pass" type="password" class="swal2-input" placeholder="Konfirmasi Password Baru">
                            </div>
                        `,
                        confirmButtonText: 'Simpan Perubahan',
                        showDenyButton: true,
                        denyButtonText: `<i class="fas fa-sign-out-alt mr-2"></i>Logout`,
                        focusConfirm: false,
                        preConfirm: () => {
                            const oldPass = document.getElementById('swal-input-old-pass').value;
                            const newPass = document.getElementById('swal-input-new-pass').value;
                            const confirmPass = document.getElementById('swal-input-confirm-pass').value;
                            
                            if (!oldPass && !newPass && !confirmPass) {
                                return true;
                            }

                            const userIndex = allowedUsers.value.findIndex(u => u.user === loggedInUser.value);
                            
                            if (userIndex === -1) {
                                Swal.showValidationMessage(`Terjadi kesalahan: User tidak ditemukan.`);
                                return false;
                            }

                            const currentUser = allowedUsers.value[userIndex];

                            if (currentUser.pass !== oldPass) {
                                Swal.showValidationMessage(`Password lama salah.`);
                                return false;
                            }

                            if (!newPass || newPass.length < 4) {
                                Swal.showValidationMessage(`Password baru minimal 4 karakter.`);
                                return false;
                            }

                            if (newPass !== confirmPass) {
                                Swal.showValidationMessage(`Konfirmasi password baru tidak cocok.`);
                                return false;
                            }

                            allowedUsers.value[userIndex].pass = newPass;

                            return { passwordChanged: true }; 
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            if (result.value?.passwordChanged) {
                                Swal.fire(
                                    'Sukses!',
                                    'Password Anda telah berhasil diubah untuk sesi ini. Perubahan ini tidak permanen dan akan hilang saat halaman dimuat ulang.',
                                    'success'
                                );
                            }
                        } else if (result.isDenied) {
                            handleLogout();
                        }
                    });
                };

                const setupListeners = () => {
                    onSnapshot(query(productsCollection), (snapshot) => {
                        products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => console.error("Error fetching products:", error));

                    onSnapshot(query(historyCollection), (snapshot) => {
                        transactionHistory.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // FIX: Use renamed variable
                    }, (error) => console.error("Error fetching history:", error));

                    onSnapshot(query(warehousesCollection), (snapshot) => {
                        warehouses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => console.error("Error fetching warehouses:", error));

                    isLoading.value = false;
                };

                // Computed Properties
                const productsWithCalculatedStock = computed(() => {
                    return products.value.map(p => {
                        const packingLocation = (p.locations || []).find(l => l.warehouse === 'PACKING');
                        const packingStock = packingLocation ? packingLocation.quantity : 0;
                        const packingStockSingle = packingLocation ? (packingLocation.single || 0) : 0;
                        const packingStockBundling = packingLocation ? (packingLocation.bundling || 0) : 0;
                        const packingPIC = packingLocation ? (packingLocation.pic || '-') : '-';
                        
                        const totalStock = (p.locations || []).reduce((sum, loc) => sum + loc.quantity, 0);
                        const gudangStock = totalStock - packingStock;
                        
                        return { 
                            ...p, 
                            stock: totalStock, 
                            packingStock, 
                            gudangStock,
                            packingStockSingle,
                            packingStockBundling,
                            packingPIC
                        };
                    }).sort((a,b) => a.name.localeCompare(b.name));
                });


                const filteredProducts = computed(() => {
                    if (!searchQuery.value) {
                        return productsWithCalculatedStock.value;
                    }

                    const query = searchQuery.value.toLowerCase();
                    return productsWithCalculatedStock.value.filter(p => 
                        p.name.toLowerCase().includes(query) || 
                        p.sku.toLowerCase().includes(query) ||
                        (p.locations && p.locations.some(l => l.warehouse.toLowerCase().includes(query) || l.rack.toLowerCase().includes(query)))
                    );
                });

                const productsInSelectedRack = computed(() => {
                    if (!selectedWarehouseId.value || !selectedRackName.value) return [];
                    
                    const selectedWarehouse = warehouses.value.find(w => w.id === selectedWarehouseId.value);
                    if (!selectedWarehouse) return [];

                    const warehouseName = selectedWarehouse.name;
                    const rackName = selectedRackName.value;

                    return products.value
                        .filter(p => p.locations && p.locations.some(loc => loc.warehouse === warehouseName && loc.rack === rackName))
                        .map(p => {
                            const loc = p.locations.find(l => l.warehouse === warehouseName && l.rack === rackName);
                            return {
                                ...p,
                                stockInRack: loc ? loc.quantity : 0
                            };
                        });
                });

                const stockCardData = computed(() => {
                    const defaultResult = { transactions: [], stokAwal: 0, periode: '', productName: '' };
                    if (!selectedStockCardProduct.value) return defaultResult;
                    
                    const product = productsWithCalculatedStock.value.find(p => p.sku === selectedStockCardProduct.value);
                    if (!product) return defaultResult;

                    // 1. Define the current month's date range
                    const now = new Date();
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    firstDayOfMonth.setHours(0, 0, 0, 0); // Start of the day
                    const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    lastDayOfMonth.setHours(23, 59, 59, 999); // End of the day

                    const periode = now.toLocaleString('id-ID', { month: 'long', year: 'numeric' });

                    // 2. Calculate Stok Awal for the current month
                    const transactionsSinceStartOfMonth = transactionHistory.value
                        .filter(t => t.sku === selectedStockCardProduct.value && t.timestamp >= firstDayOfMonth.getTime());
                    
                    const totalMasukBulanIni = transactionsSinceStartOfMonth
                        .filter(t => t.type === 'in')
                        .reduce((sum, t) => sum + t.quantity, 0);
                        
                    const totalKeluarBulanIni = transactionsSinceStartOfMonth
                        .filter(t => t.type === 'out')
                        .reduce((sum, t) => sum + t.quantity, 0);

                    const stokAwal = product.stock - totalMasukBulanIni + totalKeluarBulanIni;

                    // 3. Filter transactions for the current month view
                    const transactionsInMonth = transactionHistory.value
                        .filter(t => 
                            t.sku === selectedStockCardProduct.value &&
                            t.timestamp >= firstDayOfMonth.getTime() &&
                            t.timestamp <= lastDayOfMonth.getTime()
                        )
                        .sort((a, b) => a.timestamp - b.timestamp);

                    // 4. Calculate running stock for each transaction in the month
                    let runningStock = stokAwal;
                    const processedTransactions = transactionsInMonth.map(item => {
                        if (item.type === 'in') {
                            runningStock += item.quantity;
                        } else {
                            runningStock -= item.quantity;
                        }
                        
                        // Fallback for old records without 'keterangan'
                        if (!item.keterangan) {
                            if (item.type === 'in') {
                                item.keterangan = item.location === 'PACKING' ? 'Stock Packing' : 'Inbound';
                            } else {
                                item.keterangan = item.location === 'PACKING' ? 'Stock Packing' : 'Di Ambil';
                            }
                        }

                        return { ...item, stokAkhir: runningStock };
                    });

                    return {
                        transactions: processedTransactions,
                        stokAwal: stokAwal,
                        periode: periode,
                        productName: product.name
                    };
                });


                const productSummary = computed(() => {
                    return productsWithCalculatedStock.value.map(p => {
                        const productHistory = transactionHistory.value.filter(h => h.sku === p.sku); // FIX: Use renamed variable
                        const totalIn = productHistory
                            .filter(h => h.type === 'in')
                            .reduce((sum, h) => sum + h.quantity, 0);
                        const totalOut = productHistory
                            .filter(h => h.type === 'out')
                            .reduce((sum, h) => sum + h.quantity, 0);
                        
                        return { sku: p.sku, name: p.name, totalIn, totalOut, stock: p.stock };
                    }).sort((a,b) => a.name.localeCompare(b.name));
                });

                const lastTenStockIn = computed(() => {
                    return transactionHistory.value // FIX: Use renamed variable
                        .filter(h => h.type === 'in')
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 10);
                });

                const lastTenStockOut = computed(() => {
                    return transactionHistory.value // FIX: Use renamed variable
                        .filter(h => h.type === 'out')
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 10);
                });

                const reportTitle = computed(() => {
                    if (reportStartDate.value && reportEndDate.value) {
                        const start = new Date(reportStartDate.value).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                        const end = new Date(reportEndDate.value).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                        return `Ringkasan Transaksi (${start} - ${end})`;
                    }
                    return 'Ringkasan Transaksi Hari Ini';
                });

                const reportData = computed(() => {
                    let startTimestamp, endTimestamp;
                    const hasDateFilter = reportStartDate.value && reportEndDate.value;

                    if (hasDateFilter) {
                        const start = new Date(reportStartDate.value);
                        start.setHours(0, 0, 0, 0);
                        startTimestamp = start.getTime();

                        const end = new Date(reportEndDate.value);
                        end.setHours(23, 59, 59, 999);
                        endTimestamp = end.getTime();
                    } else {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        startTimestamp = today.getTime();

                        const endOfToday = new Date();
                        endOfToday.setHours(23, 59, 59, 999);
                        endTimestamp = endOfToday.getTime();
                    }

                    const report = [];

                    productsWithCalculatedStock.value.forEach(product => {
                        const { sku, name, stock: sisaStokSekarang } = product;

                        const transactionsSinceStart = transactionHistory.value.filter(h => // FIX: Use renamed variable
                            h.sku === sku && h.timestamp >= startTimestamp
                        );
                        
                        const totalMasukSinceStart = transactionsSinceStart.filter(t => t.type === 'in').reduce((s, t) => s + t.quantity, 0);
                        const totalKeluarSinceStart = transactionsSinceStart.filter(t => t.type === 'out').reduce((s, t) => s + t.quantity, 0);
                        
                        const stokAwal = sisaStokSekarang - totalMasukSinceStart + totalKeluarSinceStart;

                        const transactionsInPeriod = transactionsSinceStart.filter(h => h.timestamp <= endTimestamp);
                        const jumlahMasuk = transactionsInPeriod.filter(t => t.type === 'in').reduce((s, t) => s + t.quantity, 0);
                        const jumlahKeluar = transactionsInPeriod.filter(t => t.type === 'out').reduce((s, t) => s + t.quantity, 0);
                        const sisaStok = stokAwal + jumlahMasuk - jumlahKeluar;

                        if (stokAwal > 0 || jumlahMasuk > 0 || jumlahKeluar > 0) {
                             report.push({ name, sku, stokAwal, jumlahMasuk, jumlahKeluar, sisaStok });
                        }
                    });

                    return report.sort((a, b) => a.name.localeCompare(b.name));
                });


                const topProductsByStock = computed(() => {
                    return productsWithCalculatedStock.value
                        .sort((a, b) => b.stock - a.stock)
                        .slice(0, 5);
                });


                // --- Chart Logic ---
                const destroyCharts = () => {
                    Object.values(chartInstances.value).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    chartInstances.value = {};
                };

                const renderCharts = () => {
                    destroyCharts();
                    
                    if (products.value.length === 0 || topProductsByStock.value.length === 0 || currentView.value !== 'dashboard') return;
                     
                    nextTick(() => {
                        const chartData = {
                            labels: topProductsByStock.value.map(p => p.name),
                            datasets: [{
                                label: 'Total Stok',
                                data: topProductsByStock.value.map(p => p.stock),
                                backgroundColor: [
                                    'rgba(2, 132, 199, 0.7)',
                                    'rgba(13, 148, 136, 0.7)',
                                    'rgba(79, 70, 229, 0.7)',
                                    'rgba(219, 39, 119, 0.7)',
                                    'rgba(245, 158, 11, 0.7)'
                                ],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        };

                        const pieCtx = document.getElementById('productPieChart');
                        if (pieCtx) {
                            chartInstances.value.pie = new Chart(pieCtx, {
                                type: 'pie', data: chartData, 
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }

                        const barCtx = document.getElementById('topProductsBarChart');
                        if (barCtx) {
                             chartInstances.value.bar = new Chart(barCtx, {
                                type: 'bar', data: chartData, 
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    scales: { y: { beginAtZero: true } },
                                    plugins: { legend: { display: false } }
                                }
                            });
                        }
                    });
                };

                // --- Barcode Generation & Watchers ---
                watch(products, () => {
                    nextTick(() => {
                        document.querySelectorAll('svg.product-barcode').forEach(element => {
                            const barcode = element.getAttribute('data-barcode');
                            if(barcode) {
                                JsBarcode(element, barcode, {
                                    format: "CODE128", displayValue: false, height: 40, margin: 2
                                });
                            }
                        });
                         if (currentView.value === 'dashboard') {
                            renderCharts();
                        }
                    });
                }, { deep: true, immediate: true });

                watch(currentView, (newView) => {
                    destroyCharts();
                    if (['stockIn', 'stockOut', 'history'].includes(newView)) {
                         stopScanner();
                    }
                    if (newView === 'dashboard') {
                        renderCharts();
                    }
                    if (newView !== 'history') selectedStockCardProduct.value = '';
                    if (newView !== 'gudangManagement') {
                        selectedWarehouseId.value = null;
                        selectedRackName.value = null;
                    }
                    searchQuery.value = '';
                    manualScanInput.value = '';
                });

                // --- View Management ---
                const changeView = (view) => {
                    if (currentView.value !== view) {
                        currentView.value = view;
                        // Push a new state to the browser history when the view changes
                        history.pushState({ view: view }, '', `#${view}`);
                    }
                };

                const toggleSidebar = () => isSidebarMinimized.value = !isSidebarMinimized.value;

                // --- Helper Functions ---
                const formatTimestamp = (timestamp) => {
                    if (!timestamp) return '';
                    return new Date(timestamp).toLocaleString('id-ID', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                };

                // --- Gudang Management ---
                const selectWarehouse = (warehouseId) => {
                    if (selectedWarehouseId.value === warehouseId) {
                        selectedWarehouseId.value = null;
                    } else {
                        selectedWarehouseId.value = warehouseId;
                    }
                    selectedRackName.value = null;
                };

                const selectRack = (rackName) => {
                    if (selectedRackName.value === rackName) {
                        selectedRackName.value = null;
                    } else {
                        selectedRackName.value = rackName;
                    }
                };

                const addWarehouse = async () => {
                    if (!newWarehouseName.value.trim()) {
                        Swal.fire('Gagal', 'Nama gudang tidak boleh kosong.', 'error');
                        return;
                    }
                    await addDoc(warehousesCollection, {
                        name: newWarehouseName.value.trim(),
                        racks: []
                    });
                    newWarehouseName.value = '';
                    Swal.fire('Sukses', 'Gudang baru berhasil ditambahkan.', 'success');
                };

                const addRackToWarehouse = async () => {
                    if (!selectedWarehouseForNewRack.value || !newRackName.value.trim()) {
                        Swal.fire('Gagal', 'Pilih gudang dan isi nama rak.', 'error');
                        return;
                    }
                    const warehouseRef = doc(db, warehousesCollection.path, selectedWarehouseForNewRack.value);
                    await updateDoc(warehouseRef, {
                        racks: arrayUnion(newRackName.value.trim())
                    });
                    newRackName.value = '';
                    selectedWarehouseForNewRack.value = '';
                    Swal.fire('Sukses', 'Rak baru berhasil ditambahkan.', 'success');
                };
                
                const editWarehouse = async (warehouse) => {
                     const { value: newName } = await Swal.fire({
                        title: 'Edit Nama Gudang',
                        input: 'text',
                        inputValue: warehouse.name,
                        showCancelButton: true,
                        inputValidator: (value) => !value && 'Nama tidak boleh kosong!'
                    });
                    if (newName && newName !== warehouse.name) {
                        const batch = writeBatch(db);
                        const warehouseRef = doc(db, warehousesCollection.path, warehouse.id);
                        batch.update(warehouseRef, { name: newName });
                        
                        products.value.forEach(p => {
                            const updatedLocations = (p.locations || []).map(loc => {
                                if (loc.warehouse === warehouse.name) {
                                    return { ...loc, warehouse: newName };
                                }
                                return loc;
                            });
                            const productRef = doc(db, productsCollection.path, p.id);
                            batch.update(productRef, { locations: updatedLocations });
                        });
                        
                        await batch.commit();
                        Swal.fire('Sukses', 'Nama gudang berhasil diperbarui.', 'success');
                    }
                };
                
                const deleteWarehouse = async (warehouse) => {
                    const { isConfirmed } = await Swal.fire({
                        title: 'Anda yakin?',
                        text: `Gudang "${warehouse.name}" akan dihapus. Stok di dalamnya akan ditandai "Tanpa Lokasi".`,
                        icon: 'warning',
                        showCancelButton: true
                    });
                    if (isConfirmed) {
                        const batch = writeBatch(db);
                        const warehouseRef = doc(db, warehousesCollection.path, warehouse.id);
                        batch.delete(warehouseRef);
                        
                        products.value.forEach(p => {
                            if (p.locations && p.locations.some(loc => loc.warehouse === warehouse.name)) {
                                let updatedLocations = (p.locations || []);
                                let stockToMove = 0;
                                
                                updatedLocations = updatedLocations.filter(loc => {
                                    if (loc.warehouse === warehouse.name) {
                                        stockToMove += loc.quantity;
                                        return false;
                                    }
                                    return true;
                                });
                                
                                if (stockToMove > 0) {
                                    const unassignedIndex = updatedLocations.findIndex(l => l.warehouse === 'TANPA LOKASI');
                                    if (unassignedIndex > -1) {
                                        updatedLocations[unassignedIndex].quantity += stockToMove;
                                    } else {
                                        updatedLocations.push({ warehouse: 'TANPA LOKASI', rack: 'TANPA LOKASI', quantity: stockToMove });
                                    }
                                }
                                
                                const productRef = doc(db, productsCollection.path, p.id);
                                batch.update(productRef, { locations: updatedLocations });
                            }
                        });

                        await batch.commit();
                        Swal.fire('Terhapus!', 'Gudang telah dihapus.', 'success');
                    }
                };

                const editRack = async (warehouse, rackName) => {
                     const { value: newName } = await Swal.fire({
                        title: `Edit Nama Rak "${rackName}"`,
                        input: 'text',
                        inputValue: rackName,
                        showCancelButton: true,
                        inputValidator: (value) => !value && 'Nama tidak boleh kosong!'
                    });
                     if (newName && newName !== rackName) {
                        const batch = writeBatch(db);
                        const warehouseRef = doc(db, warehousesCollection.path, warehouse.id);
                        const updatedRacks = warehouse.racks.map(r => r === rackName ? newName : r);
                        batch.update(warehouseRef, { racks: updatedRacks });

                        products.value.forEach(p => {
                             if(p.locations){
                                const updatedLocations = p.locations.map(loc => {
                                    if (loc.warehouse === warehouse.name && loc.rack === rackName) {
                                        return { ...loc, rack: newName };
                                    }
                                    return loc;
                                });
                                const productRef = doc(db, productsCollection.path, p.id);
                                batch.update(productRef, { locations: updatedLocations });
                             }
                        });

                        await batch.commit();
                        Swal.fire('Sukses', 'Nama rak berhasil diperbarui.', 'success');
                    }
                };
                
                const deleteRack = async (warehouse, rackName) => {
                    const { isConfirmed } = await Swal.fire({
                        title: 'Anda yakin?',
                        text: `Rak "${rackName}" akan dihapus. Stok di dalamnya akan ditandai "Tanpa Lokasi".`,
                        icon: 'warning',
                        showCancelButton: true
                    });
                    if (isConfirmed) {
                        const batch = writeBatch(db);
                        const warehouseRef = doc(db, warehousesCollection.path, warehouse.id);
                        batch.update(warehouseRef, { racks: arrayRemove(rackName) });
                        
                        products.value.forEach(p => {
                            if (p.locations && p.locations.some(loc => loc.warehouse === warehouse.name && loc.rack === rackName)) {
                                let updatedLocations = (p.locations || []);
                                let stockToMove = 0;

                                updatedLocations = updatedLocations.filter(loc => {
                                    if (loc.warehouse === warehouse.name && loc.rack === rackName) {
                                        stockToMove += loc.quantity;
                                        return false;
                                    }
                                    return true;
                                });

                                if (stockToMove > 0) {
                                    const unassignedIndex = updatedLocations.findIndex(l => l.warehouse === 'TANPA LOKASI');
                                    if (unassignedIndex > -1) {
                                        updatedLocations[unassignedIndex].quantity += stockToMove;
                                    } else {
                                        updatedLocations.push({ warehouse: 'TANPA LOKASI', rack: 'TANPA LOKASI', quantity: stockToMove });
                                    }
                                }
                                
                                const productRef = doc(db, productsCollection.path, p.id);
                                batch.update(productRef, { locations: updatedLocations });
                            }
                        });

                        await batch.commit();
                        Swal.fire('Terhapus!', 'Rak telah dihapus.', 'success');
                    }
                };

                // --- Product Management ---
                const addProduct = async (name, sku, barcode) => {
                    await addDoc(productsCollection, {
                        name, sku, barcode, locations: [], stock: 0
                    });
                };

                const deleteProduct = (product) => {
                    Swal.fire({
                        title: 'Anda yakin?',
                        text: `Produk "${product.name}" dan seluruh riwayat transaksinya akan dihapus permanen!`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Ya, hapus semua!',
                        cancelButtonText: 'Batal'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const productRef = doc(db, productsCollection.path, product.id);
                            await deleteDoc(productRef);

                            const historyQuery = query(historyCollection, where("sku", "==", product.sku));
                            const historySnapshot = await getDocs(historyQuery);
                            const batch = writeBatch(db);
                            historySnapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            
                            Swal.fire('Terhapus!', 'Produk dan riwayatnya telah dihapus.', 'success');
                        }
                    });
                };
                
                const openAddProductModal = () => {
                    Swal.fire({
                        title: 'Tambah Definisi Produk Baru',
                        html: `
                            <p class="text-sm text-gray-500 mb-4">Anda hanya perlu mendefinisikan produk di sini. Penambahan stok dilakukan di menu "Barang Masuk".</p>
                            <input id="swal-input-name" class="swal2-input" placeholder="Nama Produk">
                            <input id="swal-input-sku" class="swal2-input" placeholder="SKU (Nomor Unik Produk)">
                            <input id="swal-input-barcode" class="swal2-input" placeholder="Kode Barcode (bisa sama dengan SKU)">
                        `,
                        confirmButtonText: 'Simpan',
                        focusConfirm: false,
                        preConfirm: () => {
                            const name = document.getElementById('swal-input-name').value;
                            let sku = document.getElementById('swal-input-sku').value;
                            let barcode = document.getElementById('swal-input-barcode').value;

                            if (!name.trim() || !sku.trim()) {
                                Swal.showValidationMessage(`Nama dan SKU wajib diisi.`);
                                return false;
                            }
                            
                            const isSkuExist = products.value.some(p => p.sku.toLowerCase() === sku.trim().toLowerCase());
                            if (isSkuExist) {
                                Swal.showValidationMessage(`SKU "${sku}" sudah digunakan. Harap gunakan SKU lain.`);
                                return false;
                            }
                            if (!barcode.trim()) barcode = sku;
                            return { name: name.trim(), sku: sku.trim(), barcode: barcode.trim() };
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            addProduct(result.value.name, result.value.sku, result.value.barcode);
                            Swal.fire('Sukses!', 'Produk baru berhasil didefinisikan.', 'success');
                        }
                    });
                };
                
                const viewProductDetail = (product) => {
                    let locationHtml = (product.locations && product.locations.length > 0) 
                        ? product.locations.map(loc => `<li>Gudang ${loc.warehouse}, Rak ${loc.rack}: <strong>${loc.quantity} pcs</strong></li>`).join('')
                        : '<li>Stok tidak tersedia di lokasi manapun.</li>';

                    Swal.fire({
                        title: `<strong>${product.name}</strong>`,
                        html: `
                            <div class="text-left p-4">
                                <p class="mb-2"><strong class="font-medium text-gray-700">SKU:</strong> ${product.sku}</p>
                                <p class="mb-2"><strong class="font-medium text-gray-700">Kode Barcode:</strong> ${product.barcode}</p>
                                <p><strong class="font-medium text-gray-700">Total Stok:</strong> ${product.stock || 0}</p>
                                <hr class="my-2">
                                <p class="font-medium text-gray-700">Lokasi Stok:</p>
                                <ul class="list-disc list-inside">${locationHtml}</ul>
                                <div class="mt-4 flex justify-center">
                                    <svg id="barcode"></svg>
                                </div>
                            </div>
                        `,
                        showCloseButton: true,
                        showConfirmButton: false,
                        didOpen: () => {
                            JsBarcode("#barcode", product.barcode, {
                                format: "CODE128", displayValue: true, fontSize: 18, textMargin: 5
                            });
                        }
                    });
                };
                
                const showProductLocations = (product) => {
                    let locationHtml = (product.locations && product.locations.length > 0)
                        ? product.locations.filter(loc => loc.warehouse !== 'PACKING').map(loc => `
                            <li class="flex justify-between items-center p-2 rounded-md ${loc.quantity > 0 ? 'bg-green-50' : 'bg-red-50'}">
                                <span>
                                    <i class="fas fa-warehouse text-gray-500 mr-2"></i><strong>${loc.warehouse}</strong> / 
                                    <i class="fas fa-th-large text-gray-500 mx-2"></i>${loc.rack}
                                </span>
                                <span class="font-bold text-lg ${loc.quantity > 0 ? 'text-green-700' : 'text-red-700'}">${loc.quantity} pcs</span>
                            </li>`).join('')
                        : '<li class="text-center text-gray-500 p-4">Stok tidak ditemukan di lokasi gudang manapun.</li>';

                    let packingHtml = `
                        <li class="flex justify-between items-center p-2 rounded-md bg-sky-50">
                            <span>
                                <i class="fas fa-box text-gray-500 mr-2"></i><strong>Stok Packingan</strong>
                            </span>
                            <span class="font-bold text-lg text-sky-700">${product.packingStock} pcs</span>
                        </li>
                    `;

                    Swal.fire({
                        title: `Lokasi Stok: ${product.name}`,
                        html: `
                            <div class="text-left p-2">
                                <p class="mb-4 text-center text-lg">Total Stok Keseluruhan: <strong class="text-2xl text-sky-600">${product.stock}</strong> pcs</p>
                                ${packingHtml}
                                <h4 class="font-semibold mt-4 mb-2">Lokasi Gudang:</h4>
                                <ul class="space-y-2">${locationHtml}</ul>
                            </div>
                        `,
                        showCloseButton: true,
                        showConfirmButton: false,
                        width: '600px'
                    });
                };

                const viewProductRecap = (product) => {
                    changeView('history');
                    selectedStockCardProduct.value = product.sku;
                };

                // --- Transaction Management ---
                const processTransaction = async (product, quantity, type, pic, locationInfo, keteranganInput) => {
                    const productRef = doc(db, productsCollection.path, product.id);
                    
                    let updatedLocations = JSON.parse(JSON.stringify(product.locations || []));
                    let transactionLocationString = '';
                    const keterangan = keteranganInput || (type === 'in' ? 'Inbound' : 'Di Ambil');

                    if (type === 'in') {
                        const { warehouse, rack } = locationInfo;
                        transactionLocationString = `${warehouse} / ${rack}`;
                        const locIndex = updatedLocations.findIndex(l => l.warehouse === warehouse && l.rack === rack);

                        if (locIndex > -1) {
                            updatedLocations[locIndex].quantity += quantity;
                        } else {
                            updatedLocations.push({ warehouse, rack, quantity });
                        }
                    } else { // type === 'out'
                        const { locationIndex } = locationInfo;
                        const targetLocation = updatedLocations[locationIndex];
                        
                        if (!targetLocation || targetLocation.quantity < quantity) {
                            Swal.fire('Error Transaksi', 'Stok tidak cukup atau lokasi tidak valid.', 'error');
                            return; // Stop execution
                        }
                        targetLocation.quantity -= quantity;
                        transactionLocationString = `${targetLocation.warehouse} / ${targetLocation.rack}`;
                    }
                    
                    updatedLocations = updatedLocations.filter(l => l.quantity > 0);
                    
                    await updateDoc(productRef, { locations: updatedLocations });

                    await addDoc(historyCollection, {
                        sku: product.sku,
                        productName: product.name,
                        barcode: product.barcode,
                        type,
                        quantity,
                        timestamp: Date.now(),
                        location: transactionLocationString,
                        pic: pic,
                        keterangan: keterangan
                    });
                };

                // --- Packing Logic ---
                const openPackingEditModal = () => {
                    let tableRows = productsWithCalculatedStock.value.map(p => `
                        <tr class="border-b">
                            <td class="p-2 text-left">
                                ${p.name}
                                <span class="block text-xs text-gray-500">${p.sku}</span>
                            </td>
                            <td class="p-2">
                                <input type="number" min="0" id="modal-single-${p.sku}" 
                                    class="w-24 text-center p-1 border rounded-lg" 
                                    value="${p.packingStockSingle}">
                            </td>
                            <td class="p-2">
                                <input type="number" min="0" id="modal-bundling-${p.sku}" 
                                    class="w-24 text-center p-1 border rounded-lg" 
                                    value="${p.packingStockBundling}">
                            </td>
                        </tr>
                    `).join('');

                    Swal.fire({
                        title: 'Edit Stok Packingan',
                        html: `
                            <div class="max-h-[60vh] overflow-y-auto mt-4">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-white shadow-sm">
                                        <tr>
                                            <th class="p-2 text-left font-semibold">Produk</th>
                                            <th class="p-2 font-semibold">Stok Single</th>
                                            <th class="p-2 font-semibold">Stok Bundling</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        `,
                        width: '800px',
                        showCancelButton: true,
                        confirmButtonText: 'Simpan Semua Perubahan',
                        cancelButtonText: 'Batal',
                        preConfirm: () => {
                            const changesToProcess = [];
                            for (const product of productsWithCalculatedStock.value) {
                                const singleInput = document.getElementById(`modal-single-${product.sku}`);
                                const bundlingInput = document.getElementById(`modal-bundling-${product.sku}`);
                                
                                const newSingleQty = parseInt(singleInput.value, 10);
                                const newBundlingQty = parseInt(bundlingInput.value, 10);

                                if (isNaN(newSingleQty) || newSingleQty < 0 || isNaN(newBundlingQty) || newBundlingQty < 0) {
                                    Swal.showValidationMessage(`Input tidak valid untuk produk ${product.name}`);
                                    return false; // Stop processing
                                }

                                const newTotalPackingQty = newSingleQty + newBundlingQty;
                                const oldTotalPackingQty = product.packingStock;

                                if (newTotalPackingQty !== oldTotalPackingQty) {
                                    changesToProcess.push({
                                        product,
                                        newSingleQty,
                                        newBundlingQty,
                                        newTotalPackingQty,
                                        oldTotalPackingQty
                                    });
                                } else if (newSingleQty !== product.packingStockSingle || newBundlingQty !== product.packingStockBundling) {
                                     changesToProcess.push({
                                        product,
                                        newSingleQty,
                                        newBundlingQty,
                                        newTotalPackingQty,
                                        oldTotalPackingQty,
                                        noStockChange: true
                                    });
                                }
                            }
                            return changesToProcess;
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const changes = result.value;
                            if (changes.length === 0) {
                                Swal.fire('Tidak Ada Perubahan', 'Tidak ada stok yang diubah.', 'info');
                                return;
                            }

                            const batch = writeBatch(db);
                            const pic = loggedInUser.value;

                            for (const change of changes) {
                                const { product, newSingleQty, newBundlingQty, newTotalPackingQty, oldTotalPackingQty, noStockChange } = change;
                                
                                const productRef = doc(db, productsCollection.path, product.id);
                                let updatedLocations = JSON.parse(JSON.stringify(product.locations || []));
                                const packingLocIndex = updatedLocations.findIndex(l => l.warehouse === 'PACKING');

                                if (packingLocIndex > -1) {
                                    updatedLocations[packingLocIndex].quantity = newTotalPackingQty;
                                    updatedLocations[packingLocIndex].single = newSingleQty;
                                    updatedLocations[packingLocIndex].bundling = newBundlingQty;
                                    updatedLocations[packingLocIndex].pic = pic;
                                } else {
                                    updatedLocations.push({ 
                                        warehouse: 'PACKING', rack: 'PACKING', 
                                        quantity: newTotalPackingQty,
                                        single: newSingleQty,
                                        bundling: newBundlingQty,
                                        pic: pic
                                    });
                                }
                                
                                updatedLocations = updatedLocations.filter(l => !(l.warehouse === 'PACKING' && l.quantity === 0));
                                batch.update(productRef, { locations: updatedLocations });

                                if (!noStockChange) {
                                    const difference = Math.abs(newTotalPackingQty - oldTotalPackingQty);
                                    const type = newTotalPackingQty > oldTotalPackingQty ? 'in' : 'out';
                                    const historyRecord = {
                                        sku: product.sku, productName: product.name, barcode: product.barcode,
                                        type, quantity: difference, timestamp: Date.now(),
                                        location: 'PACKING', pic, keterangan: 'Stock Packing'
                                    };
                                    const newHistoryRef = doc(collection(db, historyCollection.path));
                                    batch.set(newHistoryRef, historyRecord);
                                }
                            }

                            try {
                                await batch.commit();
                                Swal.fire('Sukses!', `${changes.length} produk berhasil diperbarui.`, 'success');
                            } catch (error) {
                                console.error("Gagal memperbarui stok packing secara massal:", error);
                                Swal.fire('Error', 'Gagal menyimpan perubahan ke database.', 'error');
                            }
                        }
                    });
                };

                const openMoveProductModal = (product) => {
                    const availableLocations = (product.locations || []).filter(l => l.warehouse !== 'PACKING');
                    let sourceHtml = availableLocations.map((loc, index) => `
                        <tr class="border-b">
                            <td class="p-2 text-left">${loc.warehouse} / ${loc.rack}</td>
                            <td class="p-2 text-center font-bold">${loc.quantity}</td>
                            <td class="p-2">
                                <input type="number" min="0" max="${loc.quantity}" id="move-qty-${index}" 
                                    class="w-24 text-center p-1 border rounded-lg" placeholder="0">
                            </td>
                        </tr>
                    `).join('');

                    if (!sourceHtml) {
                        sourceHtml = `<tr><td colspan="3" class="p-4 text-center text-gray-500">Tidak ada stok yang bisa dipindahkan.</td></tr>`;
                    }

                    const warehouseOptions = warehouses.value.map(w => `<option value="${w.name}">${w.name}</option>`).join('');

                    Swal.fire({
                        title: `Pindah Stok: ${product.name}`,
                        html: `
                            <div class="text-left space-y-4">
                                <div>
                                    <h4 class="font-semibold mb-2">1. Tentukan Jumlah dari Lokasi Asal</h4>
                                    <div class="max-h-48 overflow-y-auto border rounded-lg">
                                        <table class="w-full text-sm">
                                            <thead class="sticky top-0 bg-slate-100">
                                                <tr>
                                                    <th class="p-2 text-left">Lokasi Asal</th>
                                                    <th class="p-2">Stok</th>
                                                    <th class="p-2">Jumlah Pindah</th>
                                                </tr>
                                            </thead>
                                            <tbody>${sourceHtml}</tbody>
                                        </table>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2">2. Pilih Lokasi Tujuan</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Gudang Tujuan:</label>
                                            <select id="swal-dest-wh" class="swal2-select w-full"><option value="">Pilih Gudang</option>${warehouseOptions}</select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Rak Tujuan:</label>
                                            <select id="swal-dest-rack" class="swal2-select w-full" disabled><option value="">Pilih Gudang Dulu</option></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `,
                        width: '700px',
                        showCancelButton: true,
                        confirmButtonText: 'Proses Pemindahan',
                        cancelButtonText: 'Batal',
                        didOpen: () => {
                            const whSelect = document.getElementById('swal-dest-wh');
                            const rackSelect = document.getElementById('swal-dest-rack');
                            whSelect.addEventListener('change', (e) => {
                                const selectedWh = warehouses.value.find(w => w.name === e.target.value);
                                rackSelect.innerHTML = '';
                                if (selectedWh && selectedWh.racks && selectedWh.racks.length > 0) {
                                    rackSelect.disabled = false;
                                    rackSelect.add(new Option('Pilih Rak', ''));
                                    selectedWh.racks.forEach(rack => rackSelect.add(new Option(rack, rack)));
                                } else {
                                    rackSelect.disabled = true;
                                    rackSelect.innerHTML = '<option value="">Tidak ada rak</option>';
                                }
                            });
                        },
                        preConfirm: () => {
                            const moves = [];
                            let totalToMove = 0;
                            const findOriginalIndex = (locToFind) => {
                                return product.locations.findIndex(l => l.warehouse === locToFind.warehouse && l.rack === locToFind.rack);
                            };

                            for (const [index, loc] of availableLocations.entries()) {
                                const qtyInput = document.getElementById(`move-qty-${index}`);
                                const quantity = parseInt(qtyInput.value, 10) || 0;

                                if (quantity > loc.quantity) {
                                    Swal.showValidationMessage(`Jumlah pindah dari ${loc.warehouse}/${loc.rack} melebihi stok.`);
                                    return false;
                                }
                                if (quantity > 0) {
                                    moves.push({ from: loc, quantity, originalIndex: findOriginalIndex(loc) });
                                    totalToMove += quantity;
                                }
                            }

                            if (totalToMove === 0) {
                                Swal.showValidationMessage('Tentukan jumlah barang yang akan dipindahkan.');
                                return false;
                            }

                            const destWarehouse = document.getElementById('swal-dest-wh').value;
                            const destRack = document.getElementById('swal-dest-rack').value;

                            if (!destWarehouse || !destRack) {
                                Swal.showValidationMessage('Pilih gudang dan rak tujuan.');
                                return false;
                            }

                            return { moves, totalToMove, destWarehouse, destRack };
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const { moves, totalToMove, destWarehouse, destRack } = result.value;
                            
                            const batch = writeBatch(db);
                            const pic = loggedInUser.value;
                            const productRef = doc(db, productsCollection.path, product.id);
                            let updatedLocations = JSON.parse(JSON.stringify(product.locations));

                            for (const move of moves) {
                                updatedLocations[move.originalIndex].quantity -= move.quantity;
                                const historyOut = {
                                    sku: product.sku, productName: product.name, barcode: product.barcode,
                                    type: 'out', quantity: move.quantity, timestamp: Date.now(),
                                    location: `${move.from.warehouse} / ${move.from.rack}`, pic,
                                    keterangan: 'Pindah Barang'
                                };
                                const newHistoryRefOut = doc(collection(db, historyCollection.path));
                                batch.set(newHistoryRefOut, historyOut);
                            }
                            
                            const destIndex = updatedLocations.findIndex(l => l.warehouse === destWarehouse && l.rack === destRack);
                            if (destIndex > -1) {
                                updatedLocations[destIndex].quantity += totalToMove;
                            } else {
                                updatedLocations.push({ warehouse: destWarehouse, rack: destRack, quantity: totalToMove });
                            }
                            
                            const historyIn = {
                                sku: product.sku, productName: product.name, barcode: product.barcode,
                                type: 'in', quantity: totalToMove, timestamp: Date.now(),
                                location: `${destWarehouse} / ${destRack}`, pic,
                                keterangan: 'Pindah Barang'
                            };
                            const newHistoryRefIin = doc(collection(db, historyCollection.path));
                            batch.set(newHistoryRefIin, historyIn);

                            updatedLocations = updatedLocations.filter(l => l.quantity > 0);
                            
                            batch.update(productRef, { locations: updatedLocations });
                            
                            try {
                                await batch.commit();
                                Swal.fire('Sukses!', `Berhasil memindahkan ${totalToMove} pcs ${product.name}.`, 'success');
                            } catch (error) {
                                console.error("Gagal memindahkan barang:", error);
                                Swal.fire('Error', 'Gagal menyimpan perubahan ke database.', 'error');
                            }
                        }
                    });
                };
                
                // --- Scan and Manual Input Logic ---
                 const promptForTransaction = (product, type) => {
                     const actionText = type === 'in' ? 'Masuk' : 'Keluar';
                     let htmlContent, didOpenLogic, preConfirmLogic;

                     if(type === 'in'){
                        const warehouseOptions = warehouses.value.map(w => `<option value="${w.name}">${w.name}</option>`).join('');
                        htmlContent = `
                            <p class="mb-2">Anda akan menambahkan stok untuk <strong>${product.name}</strong>.</p>
                             <input id="swal-input-quantity" type="number" class="swal2-input" placeholder="Jumlah" min="1">
                             <div class="text-left p-2 space-y-2 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi Gudang:</label>
                                    <select id="swal-location-wh" class="swal2-select"><option value="">Pilih Gudang</option>${warehouseOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi Rak:</label>
                                    <select id="swal-location-rack" class="swal2-select" disabled><option value="">Pilih Gudang Dulu</option></select>
                                </div>
                            </div>
                        `;
                        didOpenLogic = () => {
                            document.getElementById('swal-input-quantity').focus();
                            const whSelect = document.getElementById('swal-location-wh');
                            const rackSelect = document.getElementById('swal-location-rack');
                             whSelect.addEventListener('change', (e) => {
                                const selectedWh = warehouses.value.find(w => w.name === e.target.value);
                                rackSelect.innerHTML = '';
                                if(selectedWh && selectedWh.racks && selectedWh.racks.length > 0) {
                                    rackSelect.disabled = false;
                                    rackSelect.add(new Option('Pilih Rak', ''));
                                    selectedWh.racks.forEach(rack => rackSelect.add(new Option(rack, rack)));
                                } else {
                                     rackSelect.disabled = true;
                                     rackSelect.innerHTML = '<option value="">Tidak ada rak</option>';
                                }
                            });
                        };
                        preConfirmLogic = () => {
                            const quantity = parseInt(document.getElementById('swal-input-quantity').value, 10);
                            const warehouse = document.getElementById('swal-location-wh').value;
                            const rack = document.getElementById('swal-location-rack').value;
                            if (!quantity || quantity <= 0) return Swal.showValidationMessage('Jumlah harus diisi.');
                            if (!warehouse || !rack) return Swal.showValidationMessage('Gudang dan Rak harus dipilih.');
                            return { quantity, locationInfo: { warehouse, rack } };
                        };
                     } else { // type === 'out'
                        const locationOptions = (product.locations || []).filter(loc => loc.quantity > 0 && loc.warehouse !== 'PACKING').map((loc, index) => `<option value="${index}">Gudang: ${loc.warehouse}, Rak: ${loc.rack} (Stok: ${loc.quantity})</option>`).join('');
                        if (!locationOptions) {
                            Swal.fire('Stok Gudang Habis', 'Produk ini tidak tersedia di lokasi gudang manapun (hanya ada di packing).', 'warning');
                            return;
                        }
                         htmlContent = `
                            <div class="text-left p-2 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Lokasi Pengambilan:</label>
                                    <select id="swal-location-out" class="swal2-select">${locationOptions}</select>
                                </div>
                                <div>
                                     <p id="swal-stock-info" class="text-sm text-gray-500 mb-2"></p>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Keluar:</label>
                                    <input id="swal-input-quantity" type="number" class="swal2-input" placeholder="Jumlah" min="1">
                                </div>
                            </div>
                        `;
                        didOpenLogic = () => {
                            const locSelect = document.getElementById('swal-location-out');
                            const qtyInput = document.getElementById('swal-input-quantity');
                            const stockInfo = document.getElementById('swal-stock-info');
                            const updateMaxStock = () => {
                                const selectedIndex = locSelect.value;
                                if (selectedIndex !== "") {
                                    const availableLocations = product.locations.filter(l => l.warehouse !== 'PACKING');
                                    const selectedLocation = availableLocations[selectedIndex];
                                    if(selectedLocation) {
                                       qtyInput.max = selectedLocation.quantity;
                                       stockInfo.innerText = `Stok tersedia di lokasi ini: ${selectedLocation.quantity} pcs.`;
                                    }
                                } else {
                                    qtyInput.max = null;
                                    stockInfo.innerText = 'Pilih lokasi untuk melihat stok tersedia.';
                                }
                            };
                            locSelect.addEventListener('change', updateMaxStock);
                            updateMaxStock();
                        };
                        preConfirmLogic = () => {
                            const quantity = parseInt(document.getElementById('swal-input-quantity').value, 10);
                            const locationIndexStr = document.getElementById('swal-location-out').value;
                            if (locationIndexStr === "") return Swal.showValidationMessage('Pilih lokasi pengambilan.');
                            
                            const availableLocations = product.locations.filter(l => l.warehouse !== 'PACKING');
                            const selectedLocation = availableLocations[locationIndexStr];
                            const originalIndex = product.locations.findIndex(l => l.warehouse === selectedLocation.warehouse && l.rack === selectedLocation.rack);

                            if (!quantity || quantity <= 0) return Swal.showValidationMessage('Jumlah harus diisi.');
                            if (quantity > selectedLocation.quantity) return Swal.showValidationMessage(`Stok tidak mencukupi (tersedia: ${selectedLocation.quantity}).`);
                            
                            return { quantity, locationInfo: { locationIndex: originalIndex } };
                        };
                     }

                     Swal.fire({
                         title: `${actionText}: ${product.name}`,
                         html: htmlContent,
                         focusConfirm: false, showCancelButton: true,
                         confirmButtonText: `Proses ${actionText}`,
                         cancelButtonText: 'Batal',
                         didOpen: didOpenLogic,
                         preConfirm: preConfirmLogic
                     }).then(result => {
                         if (result.isConfirmed) {
                             if (type === 'in') {
                                 Swal.fire({
                                     title: 'Tambahkan Keterangan',
                                     input: 'text',
                                     inputPlaceholder: 'Keterangan (contoh: Dari Supplier A)',
                                     showCancelButton: true,
                                     confirmButtonText: 'Simpan',
                                     cancelButtonText: 'Lewati'
                                 }).then(keteranganResult => {
                                     const keterangan = keteranganResult.value || 'Inbound';
                                     const pic = loggedInUser.value;
                                     processTransaction(product, result.value.quantity, type, pic, result.value.locationInfo, keterangan);
                                     const successMessage = `${result.value.quantity} ${product.name} berhasil ditambahkan oleh ${pic}.`;
                                     Swal.fire('Sukses!', successMessage, 'success');
                                 });
                             } else {
                                 const pic = loggedInUser.value;
                                 processTransaction(product, result.value.quantity, type, pic, result.value.locationInfo);
                                 const successMessage = `${result.value.quantity} ${product.name} berhasil dikeluarkan oleh ${pic}.`;
                                 Swal.fire('Sukses!', successMessage, 'success');
                             }
                         }
                     });
                 };
                
                const onScanSuccess = (decodedText, decodedResult) => {
                    stopScanner();
                    const product = products.value.find(p => p.barcode === decodedText || p.sku === decodedText);
                    if (product) {
                        if (currentView.value === 'history') {
                            selectedStockCardProduct.value = product.sku;
                            Swal.fire({
                                toast: true, position: 'top-end', icon: 'success',
                                title: `Filter diterapkan untuk: ${product.name}`,
                                showConfirmButton: false, timer: 2500
                            });
                        } else if (currentView.value === 'packing') {
                            searchQuery.value = product.sku;
                             Swal.fire({
                                toast: true, position: 'top-end', icon: 'info',
                                title: `Produk ${product.name} ditemukan.`,
                                showConfirmButton: false, timer: 2500
                            });
                        }
                        else {
                            promptForTransaction(product, currentView.value.replace('stock', '').toLowerCase());
                        }
                    } else {
                        Swal.fire('Tidak Ditemukan', `Produk dengan kode "${decodedText}" tidak ditemukan.`, 'warning');
                    }
                };

                const startScanner = () => {
                    isScannerActive.value = true;
                    nextTick(() => {
                        try {
                            html5QrCode = new Html5Qrcode("reader");
                            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                            html5QrCode.start(
                                { facingMode: "environment" }, 
                                config, 
                                onScanSuccess,
                                (errorMessage) => { /* ignore */ }
                            ).catch(err => {
                                isScannerActive.value = false;
                                Swal.fire('Error', 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.', 'error');
                            });
                        } catch (e) {
                            console.error(e);
                        }
                    });
                };

                const stopScanner = () => {
                    if (isScannerActive.value && html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop().then(() => isScannerActive.value = false)
                        .catch(err => {
                            console.error("Gagal menghentikan scanner.", err);
                            isScannerActive.value = false;
                        });
                    } else {
                        isScannerActive.value = false;
                    }
                };

                const processManualScan = () => {
                    const code = manualScanInput.value.trim();
                    if (!code) return;
                    const product = products.value.find(p => p.barcode.toLowerCase() === code.toLowerCase() || p.sku.toLowerCase() === code.toLowerCase());
                    if (product) {
                        if (currentView.value === 'history') {
                            selectedStockCardProduct.value = product.sku;
                            Swal.fire({
                                toast: true, position: 'top-end', icon: 'success',
                                title: `Filter diterapkan untuk: ${product.name}`,
                                showConfirmButton: false, timer: 2500
                            });
                        } else if (currentView.value === 'packing') {
                            searchQuery.value = product.sku;
                             Swal.fire({
                                toast: true, position: 'top-end', icon: 'info',
                                title: `Produk ${product.name} ditemukan.`,
                                showConfirmButton: false, timer: 2500
                            });
                        }
                        else {
                            promptForTransaction(product, currentView.value.replace('stock', '').toLowerCase());
                        }
                    } else {
                        Swal.fire('Tidak Ditemukan', `Produk dengan kode "${code}" tidak ditemukan.`, 'warning');
                    }
                    manualScanInput.value = '';
                };
                
                // --- Reports Logic ---
                const downloadReportCSV = () => {
                    if (reportData.value.length === 0) {
                        Swal.fire('Tidak Ada Data', 'Tidak ada data untuk diunduh pada periode ini.', 'info');
                        return;
                    }

                    const headers = ["Nama Produk", "SKU", "Stok Awal", "Total Masuk", "Total Keluar", "Sisa Stok"];
                    let csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\r\n";

                    reportData.value.forEach(item => {
                        const row = [
                            `"${item.name.replace(/"/g, '""')}"`,
                            item.sku,
                            item.stokAwal,
                            item.jumlahMasuk,
                            item.jumlahKeluar,
                            item.sisaStok
                        ];
                        csvContent += row.join(";") + "\r\n";
                    });
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    const fileName = `Laporan Stok - ${new Date().toLocaleDateString('id-ID')}.csv`;
                    link.setAttribute("download", fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                const clearDateFilter = () => {
                    reportStartDate.value = '';
                    reportEndDate.value = '';
                };

                return {
                    isLoading, isLoggedIn, username, password, handleLogin, handleLogout, loggedInUser,
                    currentView, isMenuOpen, products, transactionHistory, searchQuery, isGudangMenuOpen,
                    filteredProducts, stockCardData, productSummary,
                    manualScanInput, isScannerActive, selectedStockCardProduct, lastTenStockIn, lastTenStockOut,
                    reportData, newWarehouseName, newRackName, selectedWarehouseForNewRack, warehouses,
                    changeView, openAddProductModal, viewProductDetail, showProductLocations,
                    viewProductRecap, formatTimestamp, startScanner, stopScanner, processManualScan,
                    reportStartDate, reportEndDate, reportTitle, clearDateFilter, downloadReportCSV,
                    isSidebarMinimized, toggleSidebar, openProfileModal,
                    deleteProduct, addWarehouse, addRackToWarehouse, 
                    editWarehouse, deleteWarehouse, editRack, deleteRack,
                    selectedWarehouseId, selectedRackName, selectWarehouse, selectRack, productsInSelectedRack,
                    openPackingEditModal, openMoveProductModal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
